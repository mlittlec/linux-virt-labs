# Deploy Oracle Cloud Native Environment 1

## Overview

This documentation covers all major Ansible playbooks, Jinja2 templates, and supporting assets for the Oracle Cloud Native Environment (Oracle CNE) Lab Suite. It enables users to understand, customize, and extend automated deployments of Oracle Linux, Kubernetes, and Rook/Ceph-powered storage across Oracle Cloud Infrastructure (OCI).

All documentation is auto-generated per playbook or template, providing comprehensive usage, variables, logic, and file relationships.

---

## Contents

- [Deploy Oracle Cloud Native Environment 1](#deploy-oracle-cloud-native-environment-1)
  - [Overview](#overview)
  - [Contents](#contents)
  - [Playbooks](#playbooks)
  - [Jinja2 Templates](#jinja2-templates)
  - [Tree Listing](#tree-listing)
  - [Relationships and Workflow](#relationships-and-workflow)
  - [Platform Integration](#platform-integration)
  - [References](#references)
  - [Quickstart](#quickstart)

---

## Playbooks

| Playbook  | Summary | Related Templates / Files |
| ------------------------------ | ------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------- |
| build.yml | Launches OCI VM instances, networks, attaches storage and VNICs. | - |
| ceph_deployments.yml | Renders and distributes Ceph/Rook/CephFS manifests to control plane nodes. | cluster.j2, filesystem.j2, toolbox.j2, vm.j2, storageclass.j2, pvc.j2 |
| create_fss.yml | Provisions OCI FSS (NFS), exports, and records IDs for use in storage templates. | fss_vars.j2, fss_pv.j2, fss_pvc.j2, fss_pod.j2 |
| create_instance.yml | Orchestrates full environment spin-up, network/VLAN, image lookup, instance, storage, and registry creation. | oci_vars.j2, ingress/egress_security_rules.j2, default_vars.yml |
| create_lb.yml | Provisions OCI LB, configures health checks, backend set, exports LB IP to vars. | lb_vars.j2 |
| create_ocir.yml | Provisions OCI Container Registry and writes config for image integration. | ocir_vars.j2 |
| create_vlan.yml | Provisions VLAN in OCI/VCN and sets associated security groups. | - |
| default_vars.yml | Defines default topology, sizing, and feature toggles. | - |
| delete_fss.yml / delete_lb.yml / delete_ocir.yml | Teardown/removes FSS, Load Balancer, and Registry resources from OCI. | - |
| deploy_ocne_* | Orchestrate full OCNE cluster install (compact/full/quick/vlan/none). | myenvironment.j2 (in some flows) |
| fss_deployments.yml | Renders NFS-backed PV, PVC, and test pod manifests from FSS outputs. | fss_pv.j2, fss_pvc.j2, fss_pod.j2 |
| host_assign_vlan_ip.yml | Assigns static VLAN IPs and builds SSH trust for all nodes. | - |
| host_setup.yml | Sets up users, keys, directories, and enables passwordless SSH for automation. | -  |
| ol8_repo_config.yml / ol9_repo_config.yml | Enables/disables YUM repos for OL8/OL9 and OLCNE install/update. | - |
| preconfig_oci_ccm.yml | Sets OCI CCM env variables in .bashrc for controller/cluster manager integration. | - |
| provision_istio.yml | Deploys Istio mesh module, renders and applies custom LB setup. | istio_lb.j2 |
| provision_kubectl.yml | Gives cluster users non-root access to kubectl, copying and exporting config. | - |
| provision_oci_ccm.yml | Deploys Oracle CCM for dynamic LB/service and cloud integration. | oci_vars.j2 |
| provision_ocne.yml | Manual path for full cluster install with conditional logic and config export. | myenvironment.j2 |

---

## Jinja2 Templates

| Template                  | Purpose / Usage                                               |
| ------------------------- | ------------------------------------------------------------- |
| cluster.j2                | CephCluster CR (Rook/Ceph storage)                            |
| filesystem.j2             | CephFilesystem CR (CephFS persistence)                        |
| toolbox.j2                | Rook Ceph toolbox pod/deployment for CLI ops/troubleshooting  |
| vm.j2                     | KubeVirt VM manifest (K8s + OCI image + CephFS + cloud-init)  |
| storageclass.j2           | StorageClass for dynamic CephFS PV provisioning (rook-cephfs) |
| pvc.j2 / fss_pvc.j2       | PVCs for CephFS (dynamic/static provisioning flows)           |
| fss_pv.j2                 | Static PersistentVolume for OCI FSS via CSI                   |
| fss_pod.j2                | Test/demo pod mounting the above PVC                          |
| fss_vars.j2 / oci_vars.j2 / lb_vars.j2 / ocir_vars.j2 | Dynamic YAML config/vars generated by playbooks |
| ingress_security_rules.j2 / egress_security_rules.j2 | Vars for security list rules in OCI, rendered by automation |
| istio_lb.j2               | OCI LB (internal, flex) setup for Istio Gateway               |
| myenvironment.j2          | Master configuration file for `olcnectl` environment/module creation   |

---

## Tree Listing

```markdown
|── ocne
    ├── build.md
    ├── ceph_deployments.md
    ├── create_fss.md
    ├── create_instance.md
    ├── create_lb.md
    ├── create_ocir.md
    ├── create_vlan.md
    ├── default_vars.md
    ├── delete_fss.md
    ├── delete_lb.md
    ├── delete_ocir.md
    ├── deploy_ocne_compact.md
    ├── deploy_ocne_full.md
    ├── deploy_ocne_none.md
    ├── deploy_ocne_quick.md
    ├── deploy_ocne_vlan.md
    ├── fss_deployments.md
    ├── host_assign_vlan_ip.md
    ├── host_setup.md
    ├── ol8_repo_config.md
    ├── ol9_repo_config.md
    ├── preconfig_oci_ccm.md
    ├── provision_istio.md
    ├── provision_kubectl.md
    ├── provision_oci_ccm.md
    ├── provision_ocne.md
    ├── pvc.j2.md
    ├── README copy.md
    ├── README.md
    └── templates
        ├── cluster.j2.md
        ├── egress_security_rules.j2.md
        ├── filesystem.j2.md
        ├── fss_pod.j2.md
        ├── fss_pv.j2.md
        ├── fss_pvc.j2.md
        ├── fss_vars.j2.md
        ├── ingress_security_rules.j2.md
        ├── istio_lb.j2.md
        ├── lb_vars.j2.md
        ├── myenvironment.j2.md
        ├── oci_vars.j2.md
        ├── ocir_vars.j2.md
        ├── storageclass.j2.md
        ├── toolbox.j2.md
        └── vm.j2.md
```

---

## Relationships and Workflow

- **create_instance.yml** chains the full OCI environment: networks, VMs, FSS, VLAN, LB, registry.
- Storage and registry IDs/outputs are captured to *_vars.yml and consumed in all downstream playbooks/templates.
- **ceph_deployments.yml** and **fss_deployments.yml** generate K8s manifests driven by earlier playbook outputs.
- **deploy_ocne_*** playbooks install the core K8s/OCNE stack, referencing myenvironment.j2 in manual flows.
- All templates are documented—see individual docs for examples, variable mappings, and rendered outputs.
- **Teardown** handled by matching delete_*.yml playbooks, using IDs/vars from `*_vars.yml`.

---

## Platform Integration

These playbooks and templates support:

- Oracle Linux 8/9, Kubernetes-on-OCI with full Rook/CephFS storage and KubeVirt support
- Automated security group/network, VM, and application provisioning
- Flexible, re-usable yaml/Jinja2 templates for easy environment refresh

## References

- [Oracle Cloud Infrastructure Ansible OCI Collection](https://docs.oracle.com/en-us/iaas/tools/oci-ansible-collection/5.5.0/)  
- [OCNE Product Docs](https://docs.oracle.com/en/operating-systems/olcne/)  
- [Rook/CephFS](https://rook.io/docs/rook/latest/ceph-storage/)  
- [KubeVirt](https://kubevirt.io/)

---

## Quickstart

1. Clone the playbooks repo and review [default_vars.yml](default_vars.yml).
2. Select a playbook directory under /ocne, review specific .md files for each playbook/template.
3. Populate or override variable files as required (cloud credentials, subnet, LB, FSS).
4. Deploy via Ansible: `ansible-playbook create_instance.yml`, `ansible-playbook deploy_ocne_full.yml`, etc.
5. Explore rendered manifests and configuration in `/docs/ocne`.

**Note:** If running in your own tenancy, read the `linux-virt-labs` GitHub project [README.md](https://github.com/oracle-devrel/linux-virt-labs) and complete the prerequisites before deploying the lab environment.

1. Open a terminal on the Luna Desktop.

1. Clone the `linux-virt-labs` GitHub project.

   ```shell
   git clone https://github.com/oracle-devrel/linux-virt-labs.git
   ```

1. Change into the working directory.

   ```shell
   cd linux-virt-labs/ocne2
   ```

1. Install the required collections.

   ```shell
   ansible-galaxy collection install -r requirements.yml
   ```

1. **Customize variables**

   Edit `default_vars.yml` to set your:
   - Compartment, region, and other tenancy details
   - Instance/layout configuration
   - Feature flags (block storage, FSS, Podman, Oracle CNE variant, etc.)

1. Deploy the lab environment.

   Use the `create_instance.yml` file to initiate the creation of a preconfigured environment which you can use to run Oracle CNE. The examples below, while not exhaustive, demonstrate how to deploy different environments using the Oracle CNE repository.

   a. Deploy a single Oracle Linux Environment ready for you to setup and install an Oracle CNE install using the compact deployment method. The three Oracle Linux instances will be configured with:

      - An Oracle user account (used during the installation) with sudo access
      - Key-based SSH, also known as password-less SSH, between the hosts
      - Installation od Oracle CNE
  
         i. Update the Oracle CNE configuration.
  
           ```shell
           cat << EOF | tee instances.yml > /dev/null
           compute_instances:
            1:
              instance_name: "ocne-compact"
              type: "operator"
           EOF
           ```

        ii. Deploy the environment.

          ```shell
          ansible-playbook create_instance.yml -e localhost_python_interpreter="/usr/bin/python3.6" -e ocne_type=compact -e "@instances.yml"
          ```

   b. Deploy a 3-Node Oracle Linux Environment ready for you to setup and install an Oracle CNE install using the Quick Install method. Each of the three Oracle Linux instances will be configured with:

      - An Oracle user account (used during the installation) with sudo access
      - Key-based SSH, also known as password-less SSH, between the hosts

      ```shell
      ansible-playbook create_instance.yml -e localhost_python_interpreter="/usr/bin/python3.6" -e ocne_type=none
      ```

---

*For detailed explanations of any playbook, template, or output file, see the corresponding `.md` file in this directory.*
